// backend/scripts/patch-remove-supabase.js
// Backs up and replaces any backend JS files that import/require supabaseClient
// or use .or(... .ilike ...) with a safe Node-only delegating route.
// Always creates a .bak file before changing anything.

const fs = require('fs');
const path = require('path');

const root = path.join(__dirname, '..'); // backend/
function walk(dir) {
  const out = [];
  for (const name of fs.readdirSync(dir)) {
    const full = path.join(dir, name);
    const st = fs.statSync(full);
    if (st.isDirectory()) {
      out.push(...walk(full));
    } else if (full.endsWith('.js')) {
      out.push(full);
    }
  }
  return out;
}

function backup(file) {
  const bak = file + '.bak';
  if (!fs.existsSync(bak)) {
    fs.copyFileSync(file, bak);
  }
}

function containsSupabaseUsage(txt) {
  return /supabaseClient|\.ilike|\.or\(|\bsupabase\b|postgrest/i.test(txt);
}

function replacementForRoute(filePath) {
  // This replacement produces a minimal route file that delegates to getSalesHandler
  // and avoids supabase entirely.
  const rel = path.relative(root, filePath);
  return `// AUTO-GENERATED by patch-remove-supabase.js (safe replacement for ${rel})
// This file was replaced because it contained Supabase/PostgREST calls that
// triggered PGRST100 errors. A backup of the original file exists as ${path.basename(filePath)}.bak
const express = require('express');
const router = express.Router();
const { getSalesHandler } = require('../controllers/salesController');

// Delegates GET / to the local node handler (safe, in-memory filtering)
router.get('/', getSalesHandler);

module.exports = router;
`;
}

function run() {
  const files = walk(root);
  let changed = 0;
  for (const f of files) {
    try {
      const txt = fs.readFileSync(f, 'utf8');
      if (containsSupabaseUsage(txt)) {
        console.log('Found file using supabase/postgrest patterns:', f);
        backup(f);
        // If file path ends with routes/sales.js or contains "routes" and "sales", be extra safe: replace
        const newContents = replacementForRoute(f);
        fs.writeFileSync(f, newContents, 'utf8');
        console.log('Patched', f, '-> backup at', f + '.bak');
        changed++;
      }
    } catch (err) {
      console.error('Error processing', f, err.message);
    }
  }
  console.log('Done. Files changed:', changed);
  if (changed === 0) console.log('No supabase/postgrest usage found by pattern. If you still see errors, run the repo grep commands and paste the output.');
}

run();
